<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Tree based Elemental Mesh">
    <meta name="author" content="University of Siegen" >
    <link rel="icon" href="../favicon.png">

    <title>tem_init_elemLevels &ndash; Treelm</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="../css/fontawesome.min.css" rel="stylesheet">
    <link href="../css/brands.min.css" rel="stylesheet">
    <link href="../css/regular.min.css" rel="stylesheet">
    <link href="../css/solid.min.css" rel="stylesheet">
    <link href="../css/v4-font-face.min.css" rel="stylesheet">
    <link href="../css/v4-shims.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async
            integrity="sha256-DViIOMYdwlM/axqoGDPeUyf0urLoHMN4QACBKyB58Uw=" crossorigin="anonymous"></script>
    <!-- Other scripts and stylesheets -->
    <link href="../css/local.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">Treelm </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../page/index.html">TreElm Overview</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/types.html">Derived Types</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>tem_init_elemLevels
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 0.3% of total for procedures.">101 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/tem_construction_module.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/tem_construction_module.f90.html'>tem_construction_module.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/tem_construction_module.html'>tem_construction_module</a></li>
            <li class="breadcrumb-item active" aria-current="page">tem_init_elemLevels</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    // Enable Bootstrap tooltips
    (function () {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    })();
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/tem_init_elemlevels.html#src">tem_init_elemLevels</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine tem_init_elemLevels(me, boundary, tree, stencils)  
</h2>
    

    <p>subroutine to find neighbours of cells</p>
<p>Typically every element requires information from its neighbors to perform
an update of its state.
All such required neighbors constitute a so called <a href="../module/tem_stencil_module.html">tem_stencil_module</a>.
<a href="../proc/tem_build_horizontaldependencies.html">tem_build_horizontalDependencies</a>, or the
connectivity of elements on the same refinement
level in the tree, are therefore essential for the stencils in typical
mesh-based numerical schemes.
We now sketch the method to find the connectivity of elements in the mesh
with the help of the described mesh layout.
In a distributed mesh, the first distinction has to be made with respect to
processor ownership.</p>
<div class="alert alert-success">
<dl>
<dt>Todo</dt>
<dd>
<p>tem_find_depNeigh does not exist any more
Is the element in question tem_find_depNeigh a local or remote
element?</p>
</dd>
</dl>
</div>
<p>For all <a href="../proc/identify_local_element.html">identify_local_element</a>, their actual
position in the sparse mesh has to be identified for a given
<a href="../type/treelmesh_type.html#variable-treeid~3">treeID</a>.</p>
<p>A <a href="../type/tem_path_type.html">tem_path_type</a> comparison of two nodes to
decide their relative position in the ordered list
of elements has to take into account the hierarchy of the mesh.</p>
<p>As in the actual simulation only leaves will be present, and no overlap of
refinement levels is allowed, this is a sufficient determination.
However, such overlapping regions might be created to enable the
interpolation between different levels with virtual elements.
These special elements are distinguished anyway, so this does not pose any
problem in the search for neighborhood relations.</p>
<p>An element can be either identified by its
<a href="../type/treelmesh_type.html#variable-treeid~3">treeID</a>
or by a tuple with four integer entries for the spatial coordinates and the
refinement level: <script type="math/tex">(x, y, z, L)</script>.
This coordinate fully describes the spatial shape and position of an
element and is important to determine spatial relations between elements.
Conversion between treeIDs and coordinates can be achieved by the routines
- <a href="../proc/tem_coordofid.html">tem_CoordOfId</a> Coordinate from TreeID
- <a href="../proc/tem_idofcoord.html">tem_IdOfCoord</a> TreeID from Coordinate</p>
<p>The spatial indices are limited by the refinement level:
<script type="math/tex"> x, y, z \in \mathbf{Z}_{\ge 0}: x, y, z < 2^L </script>.
To avoid undefined coordinates, movements through the mesh by additions to
indices are done in a modulo(<script type="math/tex">2^L</script>) safeguard resulting in an periodic
universe cube.
This enables the movement in the mesh in horizontal direction by index
alteration and translation into a
<a href="../type/treelmesh_type.html#variable-treeid~3">treeID</a> again.
The described procedure is completely reversible, enabling the construction
of the <a href="../type/treelmesh_type.html#variable-treeid~3">treeID</a> for any
given coordinate.
Thus, the conversion between this coordinate and the serialized
<a href="../type/treelmesh_type.html#variable-treeid~3">treeID</a>
encoding is fully described by the topology of the octree and the chosen
space-filling curve ordering of elements, as explained above.</p>
<p>With this method we can describe the neighborhood of any given element
independently of the actual solver by a simple list of relative offsets.
In contrast to the generic horizontal relation, the vertical relation
between child and parent nodes in the tree requires an interpolation
operator between different refinement levels.
This interpolation usually has to take into account solver specific
requirements, but is otherwise quite isolated from the numerical operation
on each refinement level.
The <em>TreElM library</em> offers the solver a level-wise view, as
suggested by the properties described above.
To find all required neighbors in the distributed octree, the solver merely
has to provide its horizontal dependencies.
These are described with the help of an element specific
<a href="../module/tem_stencil_module.html">tem_stencil_module</a>.
A stencil is basically a set of element-offsets <script type="math/tex">(s_x, s_y, s_z)</script>,
describing the relative positions of all required elements for a given
element.</p>
<p>In this routine, level descriptor is allocated,
all elements in tree are added into <code>me%elem</code> as fluid type,
including their <code>property, pntTID, stencil, neighID, sourceProc</code></p>


    <h3>Arguments</h3>
        <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Intent</th><th scope="col">Optional</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-me~515"></span>
              type(<a href='../type/tem_leveldesc_type.html'>tem_levelDesc_type</a>),
            </td>
<td>intent(out),</td>
              <td></td>            <td>
              allocatable
            </td>
            <td>::</td>
            <td><strong>me</strong>(:)</td>
            <td>
                <p>neighbor list containing all the neighbours for the
cells given in treeidsubset. Result of this routine</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-boundary~5"></span>
              type(<a href='../type/tem_bc_prop_type.html'>tem_BC_prop_type</a>),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>boundary</strong></td>
            <td>
                <p>boundaries for the elements with bnd property set</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-tree~128"></span>
              type(<a href='../type/treelmesh_type.html'>treelmesh_type</a>),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>tree</strong></td>
            <td>
                <p>subset of tree ids for which the neighbours will be specified</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-stencils"></span>
              type(<a href='../type/tem_stencilheader_type.html'>tem_stencilHeader_type</a>),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>stencils</strong>(:)</td>
            <td>
                <p>the given stencil</p>
            </td>
        </tr>
    </tbody>
  </table>

    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">  </span><span class="k">subroutine </span><span class="n">tem_init_elemLevels</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="p">,</span><span class="w"> </span><span class="n">boundary</span><span class="p">,</span><span class="w"> </span><span class="n">tree</span><span class="p">,</span><span class="w"> </span><span class="n">stencils</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="c">! -------------------------------------------------------------------- !</span>
<span class="w">    </span><span class="c">!&gt; neighbor list containing all the neighbours for the</span>
<span class="w">    </span><span class="c">!! cells given in treeidsubset. Result of this routine</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">tem_levelDesc_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">me</span><span class="p">(:)</span>
<span class="w">    </span><span class="c">!&gt; boundaries for the elements with bnd property set</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">tem_bc_prop_type</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">                  </span><span class="kd">::</span><span class="w"> </span><span class="n">boundary</span>
<span class="w">    </span><span class="c">!&gt; subset of tree ids for which the neighbours will be specified</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">treelmesh_type</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">                    </span><span class="kd">::</span><span class="w"> </span><span class="n">tree</span>
<span class="w">    </span><span class="c">!&gt; the given stencil</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">tem_stencilHeader_type</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">            </span><span class="kd">::</span><span class="w"> </span><span class="n">stencils</span><span class="p">(:)</span>
<span class="w">    </span><span class="c">! -------------------------------------------------------------------- !</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">tem_stencilElement_type</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tStencil</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">posInTree</span><span class="p">,</span><span class="w"> </span><span class="n">nElemsBnd</span><span class="p">,</span><span class="w"> </span><span class="n">iQQN</span><span class="p">,</span><span class="w"> </span><span class="n">iLevel</span><span class="p">,</span><span class="w"> </span><span class="n">nProcs</span><span class="p">,</span><span class="w"> </span><span class="n">hashpos</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">nStencils</span><span class="p">,</span><span class="w"> </span><span class="n">iStencil</span><span class="p">,</span><span class="w"> </span><span class="n">elemPos</span><span class="p">,</span><span class="w"> </span><span class="n">nStencilElems</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">indElem</span><span class="p">,</span><span class="w"> </span><span class="n">minLevel</span><span class="p">,</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">,</span><span class="w"> </span><span class="n">QQN</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">initlen</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">long_k</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">treeID</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">long_k</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">neighIDs</span><span class="p">(:)</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">addedPos</span>
<span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wasAdded</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">posInBCID</span>
<span class="w">    </span><span class="c">! -------------------------------------------------------------------- !</span>

<span class="w">    </span><span class="k">call </span><span class="n">tem_horizontalSpacer</span><span class="p">(</span><span class="w"> </span><span class="n">fUnit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Inside routine: tem_init_elemLevels &#39;</span>

<span class="w">    </span><span class="c">! precondition for this routine: the first stencil must be compute stencil</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">useAll</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="s1">&#39;tem_init_elemLevels:&#39;</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="s1">&#39;Error: The first stencil does not have the&#39;</span><span class="o">//</span><span class="w">    </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w">                </span><span class="s1">&#39;useAll flag set&#39;</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="s1">&#39;       The first one is considered the compute &#39;</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w">            </span><span class="o">//</span><span class="s1">&#39;stencil and&#39;</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="s1">&#39;       needs to be set for all elements.&#39;</span>
<span class="w">      </span><span class="k">call </span><span class="n">tem_abort</span><span class="p">()</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    </span><span class="n">nProcs</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">global</span><span class="p">%</span><span class="n">nParts</span>
<span class="w">    </span><span class="n">minLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">global</span><span class="p">%</span><span class="n">minLevel</span>
<span class="w">    </span><span class="n">maxLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">global</span><span class="p">%</span><span class="n">maxLevel</span>
<span class="w">    </span><span class="n">nElemsBnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">nStencils</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="w"> </span><span class="n">stencils</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="c">! -------------   Prepare a hash table   -----------------------------------</span>
<span class="w">    </span><span class="c">! Find a suitable hash size.</span>
<span class="w">    </span><span class="c">! The hash lookup is O(1), while the identification grows with</span>
<span class="w">    </span><span class="c">! log(nElems) and log(nProcs), yet allocation, deallocation and</span>
<span class="w">    </span><span class="c">! filling will cause some overhead of O(nHashes), this is an attempt to</span>
<span class="w">    </span><span class="c">! find a compromise of these parameters.</span>
<span class="w">    </span><span class="n">nHashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tree</span><span class="p">%</span><span class="n">nElems</span><span class="p">,</span><span class="w"> </span><span class="n">nProcs</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">),</span><span class="w"> </span><span class="nb">kind</span><span class="o">=</span><span class="n">long_k</span><span class="p">)</span>

<span class="w">    </span><span class="c">! @todo Find the closest smaller prime for the hash size, to minimize the</span>
<span class="w">    </span><span class="c">!       number of collisions?</span>
<span class="w">    </span><span class="c">! Limit the size of the hash:</span>
<span class="w">    </span><span class="n">nHashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">nHashes</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="n">io_buffer_size</span><span class="p">,</span><span class="w"> </span><span class="nb">kind</span><span class="o">=</span><span class="n">long_k</span><span class="p">))</span>

<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">nHashes</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">hash_elemPos</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">nHashes</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">    </span><span class="c">! Reset the hash</span>
<span class="w">    </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1_long_k</span>
<span class="w">    </span><span class="n">hash_elemPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="c">! --------------------------------------------------------------------------</span>


<span class="w">    </span><span class="n">initlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ceiling</span><span class="p">(</span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">real</span><span class="p">(</span><span class="n">tree</span><span class="p">%</span><span class="n">nElems</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">maxlevel</span><span class="o">-</span><span class="n">minlevel</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="k">call </span><span class="n">tem_alloc_levelDesc</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="p">,</span><span class="w"> </span><span class="n">minLevel</span><span class="p">,</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">,</span><span class="w"> </span><span class="n">initlen</span><span class="p">,</span><span class="w"> </span><span class="n">nStencils</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Searching the neighbors for each element ...&#39;</span>

<span class="w">    </span><span class="c">! Loop over all given stencils</span>
<span class="w">    </span><span class="n">stencilLoop</span><span class="p">:</span><span class="w"> </span><span class="k">do </span><span class="n">iStencil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nStencils</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;(&#39;   on stencil: &#39;, I0)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">iStencil</span>
<span class="w">      </span><span class="n">QQN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="n">iStencil</span><span class="p">)%</span><span class="n">QQN</span>
<span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="w"> </span><span class="n">neighIDs</span><span class="p">(</span><span class="w"> </span><span class="n">QQN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>

<span class="w">      </span><span class="c">! map user stencil to treelm definition</span>
<span class="w">      </span><span class="k">call </span><span class="n">tem_stencil_map_toTreelmDef</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="p">))</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="n">iStencil</span><span class="p">)%</span><span class="n">useAll</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c">! This stencil belongs to all elements in the tree (fluid stencil)</span>
<span class="w">        </span><span class="n">nStencilElems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">nElems</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="c">! This stencil belongs to only a subset of the tree</span>
<span class="w">        </span><span class="c">! (boundary and IBM stencils)</span>
<span class="w">        </span><span class="n">nStencilElems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="p">)%</span><span class="n">nElems</span>
<span class="w">      </span><span class="k">end if</span>

<span class="k">      write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s2">&quot;(A,I0)&quot;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;   nElems: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nStencilElems</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s2">&quot;(A,I0)&quot;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;   QQN: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">QQN</span>

<span class="w">      </span><span class="c">! Loop over all the elements connected to the current stencil</span>
<span class="w">      </span><span class="c">! stencils( iStencil )</span>
<span class="w">      </span><span class="n">elemLoop</span><span class="p">:</span><span class="w"> </span><span class="k">do </span><span class="n">indElem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nStencilElems</span>
<span class="w">        </span><span class="c">! Reset the empty stencil</span>
<span class="w">        </span><span class="c">! Create the temporary stencil for assigning the positions of the</span>
<span class="w">        </span><span class="c">! neighbor treeIDs which are added in elem%neighID</span>
<span class="w">        </span><span class="c">! also store the original stencil it depends on (depends = iStencil )</span>
<span class="w">        </span><span class="k">call </span><span class="n">init</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">tStencil</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">        </span><span class="n">QQN</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">QQN</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">        </span><span class="n">headerPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="p">)%</span><span class="n">useAll</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="c">! if the stencil is defined to be connected to all elements,</span>
<span class="w">          </span><span class="c">! then simply loop over all the fluid elements</span>
<span class="w">          </span><span class="n">posInTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indElem</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="c">! if the stencil is defined for a subset, loop over the</span>
<span class="w">          </span><span class="c">! defined subset in %elem</span>
<span class="w">          </span><span class="n">posInTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="p">)%</span><span class="n">elem</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="w"> </span><span class="n">indElem</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">end if</span>
<span class="w">        </span><span class="c">! assign fluid element with info from the tree list and properties</span>
<span class="w">        </span><span class="c">! from disk</span>
<span class="w">        </span><span class="n">treeID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">treeID</span><span class="p">(</span><span class="w"> </span><span class="n">posInTree</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="c">! Get topological info about coordinates+level</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tem_CoordOfId</span><span class="p">(</span><span class="w"> </span><span class="n">treeID</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="c">! Find position of this element in the elemList as it might be</span>
<span class="w">        </span><span class="c">! there already from previous stencil iterations</span>
<span class="w">        </span><span class="n">hashpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="w"> </span><span class="n">treeID</span><span class="p">,</span><span class="w"> </span><span class="n">nHashes</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">hashpos</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">treeID</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! cache miss</span>
<span class="w">          </span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">)%</span><span class="n">elem</span><span class="p">,</span><span class="w">                  </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">tID</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">treeID</span><span class="p">,</span><span class="w">                           </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">pntTID</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">posInTree</span><span class="p">,</span><span class="w">                        </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">eType</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">eT_fluid</span><span class="p">,</span><span class="w">                         </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">nNeighIDs</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">QQN</span><span class="p">,</span><span class="w">                              </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">sourceProc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">global</span><span class="p">%</span><span class="n">myPart</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">property</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">%</span><span class="n">ElemPropertyBits</span><span class="p">(</span><span class="n">posInTree</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">pos</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">elemPos</span><span class="w">                           </span><span class="p">)</span>
<span class="w">          </span><span class="c">! for differentiating between fluid and ghost nodes</span>
<span class="w">          </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">)%</span><span class="n">elem</span><span class="p">%</span><span class="n">property</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="n">elemPos</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>
<span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ibset</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">)%</span><span class="n">elem</span><span class="p">%</span><span class="n">property</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="n">elemPos</span><span class="p">),</span><span class="w"> </span><span class="n">prp_fluid</span><span class="p">)</span>
<span class="w">          </span><span class="c">!write(dbgunit(1),*) &quot;prp elems = &quot;, me( x(4) )%elem%property%val(elemPos)</span>
<span class="w">          </span><span class="c">!flush(dbgUnit(1))</span>
<span class="w">          </span><span class="c">!stop</span>
<span class="w">          </span><span class="n">hash</span><span class="p">(</span><span class="n">hashpos</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">treeID</span>
<span class="w">          </span><span class="n">hash_elemPos</span><span class="p">(</span><span class="w"> </span><span class="n">hashpos</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elemPos</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="c">! cache hit</span>
<span class="w">          </span><span class="n">elemPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_elemPos</span><span class="p">(</span><span class="w"> </span><span class="n">hashpos</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">end if</span>

<span class="k">        </span><span class="n">posInBCID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="c">! Only perform the boundary check based on the treeID boundary</span>
<span class="w">        </span><span class="c">! information for stencils which work on all elements (so we can</span>
<span class="w">        </span><span class="c">! actually read out the boundary information from the tree )</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iStencil</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="c">! First check, if I have prp_hasBnd</span>
<span class="w">          </span><span class="c">! If I don&#39;t take all the elements, then I can&#39;t analyze boundaries</span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="nb">btest</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">))%</span><span class="n">elem</span><span class="p">%</span><span class="n">property</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="w"> </span><span class="n">elemPos</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">prp_hasBnd</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c">! If yes, there might be no neighbors</span>
<span class="w">            </span><span class="n">nElemsBnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nElemsBnd</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span>
<span class="w">            </span><span class="n">posInBCID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nElemsBnd</span>
<span class="w">          </span><span class="k">end if</span>
<span class="k">        end if</span><span class="w"> </span><span class="c">! useAll elements? (boundary information)</span>

<span class="w">        </span><span class="c">! calculate possible neighbors or get BCID</span>
<span class="w">        </span><span class="k">call </span><span class="n">tem_calc_neighbors</span><span class="p">(</span><span class="w"> </span><span class="n">posInBCID</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">posInBCID</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">boundary_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boundary</span><span class="p">%</span><span class="n">boundary_ID</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">stencil</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="n">iStencil</span><span class="p">),</span><span class="w">   </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">x</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w">                    </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">neighIDs</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">neighIDs</span><span class="w">              </span><span class="p">)</span>

<span class="w">        </span><span class="c">! append neighbors into elem%neighID or require list</span>
<span class="w">        </span><span class="k">do </span><span class="n">iQQN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">QQN</span>

<span class="w">          </span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">))%</span><span class="n">elem</span><span class="p">%</span><span class="n">neighID</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="w"> </span><span class="n">elemPos</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">val</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">neighIDs</span><span class="p">(</span><span class="n">iQQN</span><span class="p">),</span><span class="w">                       </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">pos</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">addedPos</span><span class="p">,</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">          </span><span class="n">wasAdded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasAdded</span><span class="w"> </span><span class="p">)</span>
<span class="w">          </span><span class="n">tStencil</span><span class="p">%</span><span class="n">tIDpos</span><span class="p">(</span><span class="n">iQQN</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addedPos</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">stencils</span><span class="p">(</span><span class="n">iStencil</span><span class="p">)%</span><span class="n">requireNeighNeigh</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">neighIDs</span><span class="p">(</span><span class="n">iQQN</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">))%</span><span class="n">require</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">              </span><span class="p">&amp;</span><span class="w">          </span><span class="n">val</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">neighIDs</span><span class="p">(</span><span class="n">iQQN</span><span class="p">),</span><span class="w">   </span><span class="p">&amp;</span>
<span class="w">              </span><span class="p">&amp;</span><span class="w">          </span><span class="n">pos</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">addedPos</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span>
<span class="w">              </span><span class="p">&amp;</span><span class="w">          </span><span class="n">wasAdded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasAdded</span><span class="w"> </span><span class="p">)</span>
<span class="w">          </span><span class="k">end if</span>

<span class="k">        end do</span>

<span class="w">        </span><span class="c">! Append the temporary stencil to the element</span>
<span class="w">        </span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">4</span><span class="p">))%</span><span class="n">elem</span><span class="p">%</span><span class="n">stencil</span><span class="p">%</span><span class="n">val</span><span class="p">(</span><span class="w"> </span><span class="n">elemPos</span><span class="w"> </span><span class="p">),</span><span class="w">             </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tStencil</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">end do </span><span class="n">elemLoop</span><span class="w"> </span><span class="c">! indElem = 1, nStencilElems</span>

<span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="w"> </span><span class="n">neighIDs</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="k">end do </span><span class="n">stencilLoop</span><span class="w"> </span><span class="c">! iStencil = 1, nStencils</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">logUnit</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Finished searching the neighbors ID for each fluid.&#39;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tem_logging_isActive</span><span class="p">(</span><span class="n">main_debug</span><span class="p">%</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      do </span><span class="n">iLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minLevel</span><span class="p">,</span><span class="w"> </span><span class="n">maxLevel</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="s2">&quot;(A,I0)&quot;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Dump levelDesc%elem on level: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">iLevel</span>
<span class="w">        </span><span class="k">call </span><span class="n">tem_elemList_dump</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">iLevel</span><span class="w"> </span><span class="p">)%</span><span class="n">elem</span><span class="p">,</span><span class="w">                  </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                     </span><span class="n">compact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.,</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                     </span><span class="n">nUnit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w">                         </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                     </span><span class="n">stencil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.,</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                     </span><span class="n">string</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;after initializing level elements&#39;</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">&amp;</span><span class="w">                               </span><span class="o">//</span><span class="s1">&#39; i.e. only fluids&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">iLevel</span><span class="w"> </span><span class="p">)%</span><span class="n">require</span><span class="p">%</span><span class="n">nVals</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="s2">&quot;(A,I0)&quot;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Dump levelDesc%require on level: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">iLevel</span>
<span class="w">          </span><span class="k">call </span><span class="n">tem_require_dump</span><span class="p">(</span><span class="w"> </span><span class="n">me</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">me</span><span class="p">(</span><span class="w"> </span><span class="n">iLevel</span><span class="w"> </span><span class="p">)%</span><span class="n">require</span><span class="p">,</span><span class="w">               </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">                    </span><span class="n">nUnit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w">                         </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w">                    </span><span class="n">string</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;after initializing level elements&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">end if</span>
<span class="k">      end do</span>
<span class="k">    end if</span>

<span class="k">    write</span><span class="p">(</span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Leave  routine: tem_init_elemLevels&#39;</span>
<span class="w">    </span><span class="k">call </span><span class="n">tem_horizontalSpacer</span><span class="p">(</span><span class="w"> </span><span class="n">fUnit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbgUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>

<span class="w">  </span><span class="k">end subroutine </span><span class="n">tem_init_elemLevels</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              Treelm
 was developed by University of Siegen<br>              &copy; 2025 
<br /><small>9899d1376992</small></p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2025-07-02T13:06:23.655310+0000             </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>
  </body>
</html>